<html>

<script>
	function writeError(message) {
		divResult.innerHTML += '<br/><br/><br/><br/><br/><h1>' + citySelector.selectedOptions[0].text + ': ' + message + '</h1>';
	}

	function generateView(slots) {
		let table = generateTable(divResult, slots);
		//generateTableHead(table, [citySelector.selectedOptions[0].text], { colspan: '100%' });
		generateTableHead(table, Object.keys(slots[0]));
	}

	function generateTableHead(table, data, attr) {
		let thead = table.createTHead();
		let row = thead.insertRow();
		for (let key of data) {
			let th = document.createElement("th");
			if (attr) {
				Object.keys(attr).forEach(key => {
					th.setAttribute(key, attr[key]);
				});
			}
			let text = document.createTextNode(key);
			th.appendChild(text);
			row.appendChild(th);
		}
	}

	function generateTable(parent, data) {
		try {
			var table = document.createElement("table");
			//table.setAttribute('id', citySelector.selectedOptions[0].text);
			parent.appendChild(table);

			for (let element of data) {
				let row = table.insertRow();
				for (key in element) {
					let cell = row.insertCell();
					let text = document.createTextNode(element[key]);
					cell.appendChild(text);

					if (element['Vaccine'] == 'COVAXIN') {
						row.className = 'covaxin';
					}
					else if (element['Vaccine'] == 'COVISHIELD') {
						row.className = 'covishield';
					}
				}
			}
			return table;
		} catch (error) {
			writeError(error.message);
		}
	}

	function getFormattedDate() {
		let date = new Date();
		let year = date.getFullYear();
		let month = (1 + date.getMonth()).toString().padStart(2, '0');
		let day = date.getDate().toString().padStart(2, '0');
		return day + '-' + month + '-' + year;
	}

	function savePreferences() {
		localStorage.setItem('city', citySelector.value);
		localStorage.setItem('age', ageSelector.value);
		localStorage.setItem('dose', doseSelector.value);
		localStorage.setItem('vaccine', vaccineSelector.value);
		localStorage.setItem('sortCenters', sortCenters.checked);
		localStorage.setItem('sortCriteria', sortCriteria.value);
		localStorage.setItem('refreshTime', refreshTimeTextBox.value);
	}

	function loadPreferences() {
		localStorage.getItem('city') && (citySelector.value = localStorage.getItem('city'));
		localStorage.getItem('age') && (ageSelector.value = localStorage.getItem('age'));
		localStorage.getItem('dose') && (doseSelector.value = localStorage.getItem('dose'));
		localStorage.getItem('vaccine') && (vaccineSelector.value = localStorage.getItem('vaccine'));
		localStorage.getItem('sortCenters') && (sortCenters.checked = localStorage.getItem('sortCenters') == "true");
		localStorage.getItem('sortCriteria') && (sortCriteria.value = localStorage.getItem('sortCriteria'));
		localStorage.getItem('refreshTime') && (refreshTimeTextBox.value = localStorage.getItem('refreshTime'));
	}

	function toggleSort() {
		sortCriteria.disabled = !sortCenters.checked;
	}
</script>
<style>
	table {
		font-size: 19px;
		border-collapse: collapse;
		width: auto;
		display: inline-block;
		margin-left: 5px;
	}

	th {
		column-span: all;
	}

	th,
	td {
		text-align: left;
		padding: 5px;
		border: 1px solid black;
	}

	.covaxin {
		background-color: #65d4be8c;
	}

	.covishield {
		background-color: #fff17285;
	}

	.space {
		margin-left: 25px;
	}
</style>

<body style="font-size: 20px;">

	<label for="citySelector" class="space">District: </label>
	<select id="citySelector" onchange="startSearching();">
		<option value="314" selected>Indore</option>
		<option value="324">Dewas</option>
		<option value="318">Ujjain</option>
		<option value="312">Bhopal</option>
	</select>

	<label for="ageSelector" class="space">Age: </label>
	<select id="ageSelector" onchange="startSearching();">
		<option value="18" selected>18+</option>
		<option value="45">45+</option>
	</select>

	<label for="doseSelector" class="space">Dose: </label>
	<select id="doseSelector" onchange="startSearching();">
		<option value="0">General</option>
		<option value="1" selected>Dose 1</option>
		<option value="2">Dose 2</option>
	</select>

	<label for="vaccineSelector" class="space">Vaccine: </label>
	<select id="vaccineSelector" onchange="startSearching();">
		<option value="ALL" selected>All</option>
		<option value="COVISHIELD">Covishield</option>
		<option value="COVAXIN">Covaxin</option>
	</select>

	<input type="checkbox" id="toggleAudio" name="toggleAudio" class="space"
		onclick="startStopAudio.play();startSearching();">
	<label for="toggleAudio">Audio</label>

	<input type="checkbox" id="sortCenters" name="sortCenters" class="space" onclick="toggleSort();startSearching();">
	<label for="sortCenters">Sort Centers by </label>
	<select id="sortCriteria" onchange="startSearching();">
		<option value="Name" selected>Name</option>
		<option value="Pincode">Pincode</option>
		<option value="Vaccine">Vaccine</option>
		<option value="Date">Date</option>
		<option value="Count">Count</option>
	</select>

	<label for="refreshTime" class="space">Auto Refresh Time: </label>
	<input type="number" id="refreshTime" name="refreshTime" value="5" min="1" style="width: 50px;"
		onKeyUp="updateTime()" onchange="updateTime()">
	<label for="refreshTime">second(s)</label>
	<hr />

	<div id="divResult"></div>
</body>
<script>
	var defaultRefreshTime = 5;		//seconds
	var startStopAudio = new Audio('https://www.soundboard.com/mediafiles/22/223467-77fe60fa-b6ab-47ec-9930-d7274cd70ae4.mp3');
	var slotFoundAudio = new Audio('https://www.soundboard.com/mediafiles/22/223467-d09a0463-5981-420a-8081-2e31ef0a063f.mp3');

	var ageSelector = document.getElementById("ageSelector");
	var citySelector = document.getElementById("citySelector");
	var doseSelector = document.getElementById("doseSelector");
	var vaccineSelector = document.getElementById("vaccineSelector");

	var toggleAudio = document.getElementById("toggleAudio");
	var sortCenters = document.getElementById("sortCenters");
	var sortCriteria = document.getElementById("sortCriteria");

	var refreshTimeTextBox = document.getElementById("refreshTime");

	var divResult = document.getElementById("divResult");

	function updateTime() {
		let num = Number(refreshTimeTextBox.value);
		refreshTime = (isNaN(num) ? defaultRefreshTime : (num > 0 ? num : defaultRefreshTime));
		refreshTimeTextBox.value = refreshTime;
		refreshTime *= 1000;
		startSearching();
	}

	var refreshTime;
	var refreshCycle;

	loadPreferences();
	toggleSort();
	updateTime();

	function startSearching() {
		savePreferences();
		refreshCycle && clearInterval(refreshCycle);
		searchSlots();
		refreshCycle = setInterval(() => {
			searchSlots();
		}, refreshTime);
	}

	async function searchSlots() {
		try {
			divResult.innerHTML = '';
			const response = await fetch('https://cdn-api.co-vin.in/api/v2/appointment/sessions/calendarByDistrict?district_id=' + citySelector.value + '&date=' + getFormattedDate());
			const data = await response.json();

			let slots = [];
			if (data.centers) {
				let counter = 1;
				data.centers.forEach((center) => {
					center.sessions.sort((a, b) => { new Date(a.date) - new Date(b.date) })
						.forEach((session) => {
							if (vaccineSelector.value != 'ALL' && session.vaccine != vaccineSelector.value) {
								return false;
							}
							if (session.min_age_limit == ageSelector.value) {
								const res = {
									'No.': counter,
									Name: center.name,
									Pincode: center.pincode,
									Vaccine: session.vaccine,
									Date: session.date,
									Count: 0
								};

								if (doseSelector.value == 0) {
									res.Count = Math.ceil(session.available_capacity);
								} else if (doseSelector.value == 1) {
									res.Count = Math.ceil(session.available_capacity_dose1);
								} else if (doseSelector.value == 2) {
									res.Count = Math.ceil(session.available_capacity_dose2);
								}
								if (res.Count > 0) {
									counter++;
									slots.push(res);
								}
							}
						});
				});
			}
			if (slots.length > 0) {
				if (sortCenters.checked) {
					if (typeof slots[0][sortCriteria.value] == "number") {
						slots.sort((a, b) => b[sortCriteria.value] - a[sortCriteria.value]);
					}
					else if (typeof slots[0][sortCriteria.value] == "string") {
						slots.sort((a, b) => a[sortCriteria.value].localeCompare(b[sortCriteria.value]))
					}
					slots.map((item, index) => {
						item['No.'] = index + 1;
					});
				}
				generateView(slots);
				toggleAudio.checked && slotFoundAudio.play();
			}
			else {
				writeError('No slots');
			}
		}
		catch (error) {
			writeError(error.message);
		}
	}
</script>

</html>
