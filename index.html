<!DOCTYPE html>
<html>
<title>Girish Joshi: Covid Vaccine Slot Finder</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<!-- <meta http-equiv="content-security-policy" content="default-src 'self'"> -->

<style>
	table {
		font-size: 19px;
		border-collapse: collapse;
		width: auto;
		display: inline-block;
		margin-left: 5px;
	}

	th {
		column-span: all;
	}

	th,
	td {
		text-align: left;
		padding: 5px;
		border: 1px solid black;
	}

	.covaxin {
		background-color: #65d4be8c;
	}

	.covishield {
		background-color: #fff17285;
	}

	.sputnik {
		background-color: #da242485;
	}

	.space {
		margin-left: 0px;
	}

	select option[disabled] {
		background-color: #80808066;
	}

	.sidenav {
		height: 0;
		width: 0;
		/* position: fixed; */
		z-index: 1;
		top: 0;
		left: 0;
		background-color: white;
		overflow-x: hidden;
		transition: 0.5s;
		padding-top: 5px;
		font-size: 25px;
		border: 1px solid black;
	}

	.sidenav table {
		font-size: 25px;
	}

	select,
	input {
		font-size: 20px;
	}

	.sidenav tr td {
		padding: 8px;
		text-decoration: none;
		transition: 0.3s;
	}

	input[type=checkbox] {
		width: 20px;
		height: 20px;
	}

	#divMessage {
		margin: 5px;
		border: 1px solid red;
		width: calc(100% - 15px);
	}
</style>

<body style="font-size: 20px;">
	<span style="font-size:30px;cursor:pointer" id="myMenu" onclick="openNav()">&#9776; Search Criteria</span>
	<div id="mySidenav" class="sidenav">
		<table>
			<tr>
				<td colspan="2">
					<input type="radio" id="PIN" name="searchOption" value="PIN" checked
						onchange="searchOptionChange();startSearching();">
					<label for="PIN">Search by PIN</label>
					<input type="radio" id="DISTRICT" name="searchOption" value="DISTRICT" style="margin-left: 50px;"
						onchange="searchOptionChange();startSearching();">
					<label for="DISTRICT">Search by District</label>
				</td>
			</tr>
			<tr class="searchByPIN">
				<td>
					<label for="refreshTime" class="space">Search by PIN: </label>
				</td>
				<td>
					<input placeholder="000000" id="txtPIN" minlength="6" maxlength="6" style="width: 100px;"
						onchange="startSearching()" pattern=".[0-9]" required title="enter correct PIN">
				</td>
			</tr>
			<tr class="searchByDistrict">
				<td>
					<label for="stateSelector" class="space">State: </label>
				</td>
				<td>
					<select id="stateSelector" onchange="updateDistricts(this.value).then(()=>startSearching());">
					</select>
				</td>
			</tr>
			<tr class="searchByDistrict">
				<td>
					<label for="districtSelector" class="space">District: </label>
				</td>
				<td>
					<select id="districtSelector" onchange="startSearching();">
					</select>
				</td>
			</tr>
			<tr>
				<td>
					<label for="ageSelector" class="space">Age: </label>
				</td>
				<td>
					<select id="ageSelector" onchange="startSearching();">
						<option value="18" selected>18+</option>
						<option value="45">45+</option>
					</select>
				</td>
			</tr>
			<tr>
				<td>
					<label for="doseSelector" class="space">Dose: </label>
				</td>
				<td>
					<select id="doseSelector" onchange="startSearching();">
						<option value="0" selected>General</option>
						<option value="1">Dose 1</option>
						<option value="2">Dose 2</option>
					</select>
				</td>
			</tr>
			<tr>
				<td>
					<label for="vaccineSelector" class="space">Vaccine: </label>
				</td>
				<td>
					<select id="vaccineSelector" onchange="startSearching();">
						<option value="ALL" selected>All</option>
						<option value="COVISHIELD">Covishield</option>
						<option value="COVAXIN">Covaxin</option>
						<option value="SPUTNIK" disabled>Sputnik V</option>
					</select>
				</td>
			</tr>
			<tr>
				<td>
					<label for="refreshTime" class="space">Auto Refresh in: </label>
				</td>
				<td>
					<input type="number" id="refreshTime" name="refreshTime" value="5" min="1" style="width: 75px;"
						onchange="updateTime()">
					<label for="refreshTime" class="space"> seconds</label>
				</td>
			</tr>
			<tr>
				<td>
					<input type="checkbox" id="sortCenters" name="sortCenters" class="space"
						onclick="toggleSort();startSearching();">
					<label for="sortCenters">Sort Centers by </label>
				</td>
				<td>
					<select id="sortCriteria" onchange="startSearching();">
						<option value="Name" selected>Name</option>
						<option value="Pincode">Pincode</option>
						<option value="Vaccine">Vaccine</option>
						<option value="Date">Date</option>
						<option value="Count">Count</option>
					</select>
				</td>
			</tr>
			<tr>
				<td colspan="2">
					<input type="checkbox" id="toggleAudio" name="toggleAudio" class="space"
						onclick="startStopAudio.play();startSearching();">
					<label for="toggleAudio">Audio</label>
				</td>
			</tr>
		</table>
		<div id="divMessage" style="margin-top: 5px; ">Messages: </div>
	</div>

	<div id="divResult" style="margin-top: 25px;"></div>
</body>

<script>
	function writeError(message) {
		let errorMessage = '<br/><br/><br/><br/><br/><h1>';
		if (searchByPIN.checked) {
			if (txtPIN.value != '') {
				errorMessage += txtPIN.value + ': ' + message;
			} else {
				errorMessage += 'Please enter correct PIN.';
			}
		}
		else {
			errorMessage += districtSelector.selectedOptions[0].text + ': ' + message;
		}
		errorMessage += '</h1>';
		divResult.innerHTML = errorMessage;
	}

	function generateView(slots) {
		let table = generateTable(divResult, slots);
		//generateTableHead(table, [districtSelector.selectedOptions[0].text], { colspan: '100%' });
		generateTableHead(table, Object.keys(slots[0]));
	}

	function generateTableHead(table, data, attr) {
		let thead = table.createTHead();
		let row = thead.insertRow();
		for (let key of data) {
			let th = document.createElement("th");
			if (attr) {
				Object.keys(attr).forEach(key => {
					th.setAttribute(key, attr[key]);
				});
			}
			let text = document.createTextNode(key);
			th.appendChild(text);
			row.appendChild(th);
		}
	}

	function generateTable(parent, data) {
		try {
			var table = document.createElement("table");
			//table.setAttribute('id', districtSelector.selectedOptions[0].text);
			parent.appendChild(table);

			for (let element of data) {
				let row = table.insertRow();
				for (key in element) {
					let cell = row.insertCell();
					let text = document.createTextNode(element[key]);
					cell.appendChild(text);

					if (element['Vaccine'] == 'COVAXIN') {
						row.className = 'covaxin';
					}
					else if (element['Vaccine'] == 'COVISHIELD') {
						row.className = 'covishield';
					}
					else if (element['Vaccine'] == 'SPUTNIK') {
						row.className = 'sputnik';
					}
				}
			}
			return table;
		} catch (error) {
			writeError(error.message);
		}
	}

	function getFormattedDate() {
		let date = new Date();
		let year = date.getFullYear();
		let month = (1 + date.getMonth()).toString().padStart(2, '0');
		let day = date.getDate().toString().padStart(2, '0');
		return day + '-' + month + '-' + year;
	}

	function savePreferences() {
		localStorage.setItem('searchByPIN', searchByPIN.checked);
		localStorage.setItem('PIN', txtPIN.value);
		localStorage.setItem('state', stateSelector.value);
		localStorage.setItem('district', districtSelector.value);
		localStorage.setItem('age', ageSelector.value);
		localStorage.setItem('dose', doseSelector.value);
		localStorage.setItem('vaccine', vaccineSelector.value);
		localStorage.setItem('sortCenters', sortCenters.checked);
		localStorage.setItem('sortCriteria', sortCriteria.value);
		localStorage.setItem('refreshTime', refreshTimeTextBox.value);
	}

	async function loadPreferences() {
		if (localStorage.getItem('searchByPIN')) {
			if (localStorage.getItem('searchByPIN') == "true") {
				searchByPIN.checked = true;
			} else {
				searchByDistrict.checked = true;
			}
			searchOptionChange();
		}
		localStorage.getItem('PIN') && (txtPIN.value = localStorage.getItem('PIN'));
		localStorage.getItem('state') && (stateSelector.value = localStorage.getItem('state'));
		await updateDistricts();
		localStorage.getItem('district') && (districtSelector.value = localStorage.getItem('district'));
		localStorage.getItem('age') && (ageSelector.value = localStorage.getItem('age'));
		localStorage.getItem('dose') && (doseSelector.value = localStorage.getItem('dose'));
		localStorage.getItem('vaccine') && (vaccineSelector.value = localStorage.getItem('vaccine'));
		localStorage.getItem('sortCenters') && (sortCenters.checked = localStorage.getItem('sortCenters') == "true");
		localStorage.getItem('sortCriteria') && (sortCriteria.value = localStorage.getItem('sortCriteria'));
		localStorage.getItem('refreshTime') && (refreshTimeTextBox.value = localStorage.getItem('refreshTime'));
	}

	function toggleSort() {
		sortCriteria.disabled = !sortCenters.checked;
	}

	async function fillStates() {
		const response = await fetch('https://cdn-api.co-vin.in/api/v2/admin/location/states/');
		const json = await response.json();
		if (json.states) {
			json.states.forEach((state) => {
				let opt = document.createElement('option');
				opt.value = state.state_id;
				opt.innerHTML = state.state_name;
				stateSelector.appendChild(opt);
			});
		}
		//stateSelector.value = 20;
		await updateDistricts();
	}

	async function updateDistricts() {
		while (districtSelector.options.length) {
			districtSelector.remove(0);
		}
		const response = await fetch('https://cdn-api.co-vin.in/api/v2/admin/location/districts/' + stateSelector.value);
		const json = await response.json();
		if (json.districts) {
			json.districts.forEach((district) => {
				let opt = document.createElement('option');
				opt.value = district.district_id;
				opt.innerHTML = district.district_name;
				districtSelector.appendChild(opt);
			});
		}
	}

	function updateMessages() {
		const msgs = [
			"'Search by PIN' option is now available."
			, "Support for 'Sputnik V' is not updated yet. Kindly use 'All' option for 'Vaccine'."
			, "Preferences are auto saved except for 'Audio'."
		]

		let ol = document.createElement("OL");
		ol.setAttribute("id", "messages");
		ol.setAttribute("style", "margin-top: 5px;");
		divMessage.appendChild(ol);

		msgs.forEach(msg => {
			var li = document.createElement("LI");
			var msgText = document.createTextNode(msg);
			li.appendChild(msgText);
			ol.appendChild(li);
		});
	}

	let mySideNav = document.getElementById("mySidenav");

	function openNav() {
		if (mySideNav.style.width == '525px') {
			closeNav();
		} else {
			mySideNav.style.width = "525px";
			mySideNav.style.height = "auto";
		}
	}

	function closeNav() {
		mySideNav.style.width = "0px";
		mySideNav.style.height = "0px";
	}

	window.addEventListener('click', function (e) {
		if (!document.getElementById('mySidenav').contains(e.target) && !document.getElementById('myMenu').contains(e.target)) {
			// Clicked in box		
			closeNav();
		} else {

			// document.getElementById("mySidenav").style.width = "0px";
		}
	});

	function searchOptionChange() {
		if (searchByPIN.checked) {
			document.getElementsByClassName('searchByPIN')[0].style.display = '';
			document.getElementsByClassName('searchByDistrict')[0].style.display = 'none';
			document.getElementsByClassName('searchByDistrict')[1].style.display = 'none';
		}
		else {
			document.getElementsByClassName('searchByPIN')[0].style.display = 'none';
			document.getElementsByClassName('searchByDistrict')[0].style.display = '';
			document.getElementsByClassName('searchByDistrict')[1].style.display = '';
		}
	}

</script>

<script>
	var defaultRefreshTime = 5;		//seconds

	var startStopAudio = new Audio('https://mobcup.net/va/77f42445a619e9fa82ec6345a4f073be6');
	var slotFoundAudio = new Audio('https://mobcup.net/va/3333afbbf22897e2953914da36fd741eb');

	var stateSelector = document.getElementById("stateSelector");
	var districtSelector = document.getElementById("districtSelector");
	var ageSelector = document.getElementById("ageSelector");
	var doseSelector = document.getElementById("doseSelector");
	var vaccineSelector = document.getElementById("vaccineSelector");

	var toggleAudio = document.getElementById("toggleAudio");
	var sortCenters = document.getElementById("sortCenters");
	var sortCriteria = document.getElementById("sortCriteria");

	var refreshTimeTextBox = document.getElementById("refreshTime");

	var divResult = document.getElementById("divResult");

	var divMessage = document.getElementById("divMessage");
	updateMessages();

	var txtPIN = document.getElementById('txtPIN');
	var searchURL = '';

	var searchByPIN = document.getElementById('PIN');
	var searchByDistrict = document.getElementById('DISTRICT');

	function updateTime() {
		let num = Number(refreshTimeTextBox.value);
		refreshTime = (isNaN(num) ? defaultRefreshTime : (num > 0 ? num : defaultRefreshTime));
		refreshTimeTextBox.value = refreshTime;
		refreshTime *= 1000;
		startSearching();
	}

	var refreshTime;
	var refreshCycle;

	fillStates().then(() => {
		loadPreferences().then(() => {
			searchOptionChange();
			toggleSort();
			updateTime();
		});
	});

	function startSearching() {
		savePreferences();
		refreshCycle && clearInterval(refreshCycle);
		searchSlots();
		refreshCycle = setInterval(() => {
			searchSlots();
		}, refreshTime);
	}

	let regex = new RegExp('\\d{6}');
	function validatePIN() {
		let value = txtPIN.value;
		return regex.test(value) ? true : false;
	}

	async function searchSlots() {
		try {
			divResult.innerHTML = '';
			if (searchByPIN.checked) {
				if (validatePIN()) {
					searchURL = 'https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/calendarByPin?pincode=' + txtPIN.value + '&date=' + getFormattedDate();
				}
				else {
					writeError('Invalid PIN');
					return;
				}
			}
			else {
				searchURL = 'https://cdn-api.co-vin.in/api/v2/appointment/sessions/calendarByDistrict?district_id=' + districtSelector.value + '&date=' + getFormattedDate();
			}
			fetch(searchURL).then((response) => {
				response.json().then((data) => {
					if (data.error) {
						writeError(data.error);
					} else {
						let slots = [];
						if (data.centers) {
							let counter = 1;
							data.centers.forEach((center) => {
								center.sessions.sort((a, b) => { new Date(a.date) - new Date(b.date) })
									.forEach((session) => {
										if (vaccineSelector.value != 'ALL' && session.vaccine != vaccineSelector.value) {
											return false;
										}
										if (session.min_age_limit == ageSelector.value) {
											const res = {
												'No.': counter,
												Name: center.name,
												Pincode: center.pincode,
												Vaccine: session.vaccine,
												Date: session.date,
												Count: 0
											};

											if (doseSelector.value == 0) {
												res.Count = Math.ceil(session.available_capacity);
											} else if (doseSelector.value == 1) {
												res.Count = Math.ceil(session.available_capacity_dose1);
											} else if (doseSelector.value == 2) {
												res.Count = Math.ceil(session.available_capacity_dose2);
											}
											if (res.Count > 0) {
												counter++;
												slots.push(res);
											}
										}
									});
							});
						}
						if (slots.length > 0) {
							if (sortCenters.checked) {
								if (typeof slots[0][sortCriteria.value] == "number") {
									slots.sort((a, b) => b[sortCriteria.value] - a[sortCriteria.value]);
								}
								else if (typeof slots[0][sortCriteria.value] == "string") {
									slots.sort((a, b) => a[sortCriteria.value].localeCompare(b[sortCriteria.value]))
								}
								slots.map((item, index) => {
									item['No.'] = index + 1;
								});
							}
							generateView(slots);
							toggleAudio.checked && slotFoundAudio.play();
						}
						else {
							writeError('No slots');
						}
					}
				}).catch((err) => {
					writeError(err.message);
				});
			}).catch((error) => {
				writeError(error.message);
			});
		}
		catch (error) {
			writeError(error.message);
		}
	}
</script>

</html>